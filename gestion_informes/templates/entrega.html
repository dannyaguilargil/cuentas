{% extends 'base_informes.html' %}
{% block titulo %}Creacion del informe{% endblock titulo %}
{% block contenido %}

<center>
    <h5 class=""><b>S</b>istema de <b>A</b>dministracion de <b>R</b>ecursos y <b>A</b>plicaciones </h5>
    
</center>
      

    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
            
            </div>
            <!-- /.col -->
        
            <!-- /.col -->
          </div>
          <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
      </div>
      <!-- /.content-header -->
  
      <!-- Main content -->
      <div class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="card card-primary card-outline">
                <div class="card-header">
                  <div class="d-flex justify-content-between">
                    <h6 class="m-0">Gestión de entregas</h6>
                  </div>
                </div>
                <div class="card-body">
                  <div class="card card-primary">
                    <div class="card-header">
                      <h6 class="card-title">Datos del informe</h6>
                    </div>
                    <div class="card-body">
                      <div class="div-responsive">
                        <table
                          class="table table-striped table-bordered"
                          id="tabla-datos-del-informe"
                        >
                          <tbody>
                            <tr>
                              <td>
                                <span class="text-bold">Nombre del informe:</span>
                                {{ entcon_informe.nombre }}
                              </td>
                              <td>
                                <span class="text-bold">Normativa:</span>
                                <a
                                  :href="entcon_informe.ruta_normativa"
                                  target="_blank"
                                  >{{ entcon_informe.normativa }}</a
                                >
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <span class="text-bold">Ente de control:</span>
                                {{ entcon_informe.entcon_ente.name }}
                              </td>
                              <td>
                                <span class="text-bold">Dependencia:</span>
                                {{ entcon_informe.entcon_dependencia.name }}
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <span class="text-bold">Responsable:</span>
                                {{ entcon_informe.entcon_dependencia.responsible }}
                              </td>
                              <td>
                                <span class="text-bold">Correo del responsable:</span>
                                {{ entcon_informe.entcon_dependencia.responsible_email }}
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <span class="text-bold"
                                  >Fecha de entrega incial del informe:</span
                                >
                                
                              </td>
                              <td>
                                <span class="text-bold"
                                  >Fecha de entrega pendiente:</span
                                >
                                
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <span class="text-bold"
                                  >Periodo de repetición del Informe:</span
                                >
                                {{ entcon_informe.periodicidad_cantidad }}
                                {{ entcon_informe.periodicidad_tipo }}
                              </td>
                              <td>
                                <span class="text-bold"
                                  >Finalizar despues de cuantas entregas:</span
                                >
                                
                              </td>
                            </tr>
                            <tr>
                              <td>
                                <span class="text-bold">Estado del Informe:</span>
                              </td>
                              <td>
                                <span class="text-bold">Descripcion del Informe:</span>
                              </td>
                            </tr>
                            <tr>
                              <td colspan="3" class="text-bold text-center">
                                Alarmas
                              </td>
                            </tr>
                            <tr>
                              <td colspan="3">
                                <ul class="list-group">
                                  <li
                                    class="list-group-item"
                                    v-for="alarma in entcon_informe.entcon_alarmas"
                                    :key="alarma.id"
                                  >
                                    
                                  </li>
                                </ul>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  <div class="card card-primary">
                    <div class="card-header">
                      <h3 class="card-title">Listado de entregas</h3>
                    </div>
                    <div class="card-body">
                      <div class="div-responsive">
                        <table
                          class="table table-striped table-bordered"
                          id="tabla-listado-entregas"
                        >
                          <thead>
                            <tr>
                              <th>Num</th>
                              <th>Fecha de entrega</th>
                              <th>Evidencias</th>
                              <th class="text-center">Opciones</th>
                              <th class="text-center">Estado</th>
                            </tr>
                          </thead>
                          <tbody>
                            <td colspan="5">
                              <h4 class="text-center">
                                Cargando listado de entregas...
                              </h4>
                            </td>
                          </tbody>
                          <tfoot>
                            <tr>
                              <th>Num</th>
                              <th>Fecha de entrega</th>
                              <th>Evidencias</th>
                              <th class="text-center">Opciones</th>
                              <th class="text-center">Estado</th>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
      </div>
      <!-- /.content -->
      <ControlEntitiesLoadEvidencie />
    </div>
  
  
  <script>
  import ControlEntitiesLoadEvidencie from "./modals/ControlEntitiesLoadEvidencie";
  import EventBus from "../../EventBus";
  
  export default {
    components: {
      ControlEntitiesLoadEvidencie,
    },
    data() {
      return {
        entcon_informe: {
          nombre: "",
          entcon_ente_id: "",
          entcon_ente: {},
          normativa: "",
          entcon_dependencia_id: "",
          entcon_dependencia: {},
          fecha_entrega_inicial: "",
          fecha_entrega_pendiente: "",
          periodicidad_cantidad: "",
          periodicidad_tipo: "",
          total_entregas: "",
          entcon_alarmas: [],
        },
  
        entregas: [],
        datatable_entregas: null,
        ruta_img_loading: "/img/Cargar.gif",
  
        msgerrors: [],
      };
    },
    created() {
      EventBus.$on('reloadDeliveryList', () => this.datatable_entregas.draw())
    },
    methods: {
      cargarDatosEntconInforme() {
        let informe = this.$route.params.informe;
  
        axios
          .get(/control-entities/entcon-informes/${informe})
          .then((response) => {
            this.entcon_informe = response.data;
  
            if (!this.datatable_entregas) {
              this.cargarListadoEntregas();
            } else {
              this.datatable_entregas.draw();
            }
          })
          .catch((errors) => console.log(errors));
      },
  
      cargarListadoEntregas() {
        let self = this;
  
        self.datatable_entregas = $("#tabla-listado-entregas").DataTable({
          serverSide: true,
          ajax: {
            url: "/control-entities/entcon-entregas",
            data: function (filtros) {
              filtros.informe = self.entcon_informe.slug;
  
              return filtros;
            },
            dataSrc: function (json) {
              return (self.entregas = json.data);
            },
          },
          columns: [
            { data: "id" },
            // {
            //   data: "id",
            //   render: function (data) {
            //     return <div class="text-center">${data}</div>;
            //   },
            // },
            {
              data: "fecha",
              render: function (data) {
                return `
                  <div class="text-center">
                      ${self.formatoFecha(data)}
                  </div>
              `;
              },
            },
            {
              data: "id",
              render: function (data, type, entrega) {
                let evidencias = '<ul class="list-group">';
  
                for (let evidencia of entrega.entcon_evidencias) {
                  evidencias += `
                    <li class="list-group-item">
                        <a href="${self.getRutaEvidencia(
                          evidencia.nombre,
                          entrega.fecha
                        )}" target="_blank">${evidencia.nombre}</a>
                    </li>
                  `;
                }
  
                return evidencias.concat("</ul>");
              },
            },
            {
              data: "id",
              render: function (data, type, row) {
                let data_id = row.estado == 1 ? data : null;
                let disabled = row.estado == 1 ? "" : "disabled";
  
                return `
                  <div class="text-center">
                      <div class="btn-group min-width-140" role="group" aria-label="Basic example">
                          <button type="button" class="btn btn-sm btn-primary btn-cargar-evidencias" dusk="btn-cargar-evidencias" data-id="${data_id}" ${disabled} title="Cargar evidencias"> 
                              <i class="fas fa-cloud-upload-alt"></i> <i class="fas fa-file"></i> 
                          </button>
                      </div>
                  </div>
                `;
              },
            },
            {
              data: "estado",
              name: "estado",
              render: function (data, type, row, meta) {
                if (data == 2) {
                  return `
                    <button type="button" class="btn btn-sm btn-success center-block btn-reabarir-entrega" disabled> 
                        <i class="fas fa-lock"></i> Finalizada
                    </button>
                  `;
                }
  
                let disabled = row.entcon_evidencias.length ? "" : "disabled";
  
                return `
                              <button type="button" class="btn btn-sm btn-warning center-block btn-finalizar-entrega" data-id="${row.id}" ${disabled}> 
                                  <i class="fas fa-lock-open"></i> Pendiente
                              </button>
                          `;
              },
            },
          ],
  
          fnDrawCallback: function (settings, json) {
            setTimeout(() => {
              self.activarBotonesDeAccion();
            }, 300);
  
            $("table#tabla-listado-entregas > tbody > tr > td:first-child").click(
              function () {
                setTimeout(() => {
                  self.activarBotonesDeAccion();
                }, 300);
              }
            );
          },
  
          order: [[0, "desc"]],
  
          responsive: {
            orthogonal: "responsive",
          },
  
          language: window.datatables_language,
        });
  
        self.datatable_entregas.on("draw.dt", function () {
          var PageInfo = $("#tabla-listado-entregas").DataTable().page.info();
  
          self.datatable_entregas
            .column(0, { page: "current" })
            .nodes()
            .each(function (cell, i) {
              cell.innerHTML = `
                <div class="text-center">
                    ${PageInfo.recordsTotal - PageInfo.start - i}
                </div>
              `;
            });
        });
      },
  
      getRutaEvidencia(evidencia, entrega_fecha) {
        const hashId = 000000${this.entcon_informe.id}.substring(-7);
  
        return /soportes/control-entities/informes/${hashId}-${this.entcon_informe.slug}/entregas/${entrega_fecha}/${evidencia};
      },
  
      formatoFecha(fecha, formato = "DD/MM/YYYY") {
        return moment(fecha).format(formato);
      },
  
      activarBotonesDeAccion() {
        this.cargarEvidencias();
        this.finalizarEntrega();
      },
  
      cargarEvidencias() {
        let self = this;
  
        $("button.btn-cargar-evidencias").click(function () {
          let entrega_id = $(this).attr("data-id");
          let entrega = self.filtrarEvidencia(entrega_id);
  
          EventBus.$emit('openModalControlEntitiesLoadEvidencie', self.entcon_informe, entrega); 
        });
      },
  
      finalizarEntrega() {
        let self = this;
  
        $("button.btn-finalizar-entrega").click(function () {
          let entrega_id = $(this).attr("data-id");
          let entrega = self.filtrarEvidencia(entrega_id);
  
          Swal.fire({
            title: Esta seguro de cambiar el estado de la entrega a finalizada?,
            type: "warning",
            width: "570px",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Aceptar",
            cancelButtonText: "Cancelar",
          }).then((result) => {
            if (result.value) {
              axios
                .patch(
                  /control-entities/entcon-entregas/${entrega.id}/finalizar
                )
                .then((response) => {
                  Swal.fire({
                    width: "570px",
                    type: "success",
                    title: "Actualizado!",
                    html: "La entrega se finalizo correctamente.",
                  });
  
                  if (!response.siguiente_entrega) {
                    self.cargarDatosEntconInforme();
                  } else {
                    self.datatable_entregas.draw();
                  }
                })
                .catch((errors) => self.mostrarErroresHttpAxios(errors));
            }
          });
        });
      },
  
      /**
       * Este metodo filtra una entrega por su id.
       *
       * @param {number} indicador_id
       * @return {object}
       */
      filtrarEvidencia: function (entrega_id) {
        return this.entregas.find((valor, indice, array_old) => {
          return parseInt(valor.id) === parseInt(entrega_id);
        });
      },
    },
    mounted() {
      this.cargarDatosEntconInforme();
    },
  };
  </script>
  
  <style>
  .center-block {
    display: block;
    margin-right: auto;
    margin-left: auto;
  }
  </style>
      
      



{% endblock contenido %}